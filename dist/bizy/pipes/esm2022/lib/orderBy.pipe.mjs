import { Pipe } from '@angular/core';
import * as i0 from "@angular/core";
export class BizyOrderByPipe {
    transform(items, order = null, property = '') {
        // No items
        if (!items || !order) {
            return items;
        }
        // Array with only one item
        if (items.length <= 1) {
            return items;
        }
        const sortByString = (items, order) => {
            return items.sort((a, b) => {
                let aValue = a;
                let bValue = b;
                if (property) {
                    const nestedProperty = property.split('.');
                    nestedProperty.forEach(_property => {
                        aValue = aValue[_property];
                        bValue = bValue[_property];
                    });
                }
                if ((typeof aValue === 'undefined' || aValue === null) && (typeof bValue === 'undefined' || bValue === null)) {
                    return 0;
                }
                if ((typeof aValue === 'undefined' || aValue === null) && (typeof bValue !== 'undefined' && bValue !== null)) {
                    return order === 'desc' ? 1 : -1;
                }
                if ((typeof aValue !== 'undefined' && aValue !== null) && (typeof bValue === 'undefined' || bValue === null)) {
                    return order === 'desc' ? -1 : 1;
                }
                if (aValue === bValue) {
                    return 0;
                }
                if (order === 'desc') {
                    return (this.#removeAccentsAndDiacritics(String(aValue)).toLowerCase() > this.#removeAccentsAndDiacritics(String(bValue)).toLowerCase() ? -1 : 1);
                }
                return (this.#removeAccentsAndDiacritics(String(bValue)).toLowerCase() > this.#removeAccentsAndDiacritics(String(aValue)).toLowerCase() ? -1 : 1);
            });
        };
        const sortByNumber = (items, order) => {
            if (order === 'asc') {
                return items.sort((a, b) => Number(getValue(a)) - Number(getValue(b)));
            }
            else {
                return items.sort((a, b) => Number(getValue(b)) - Number(getValue(a)));
            }
        };
        const sortByDate = (items, order) => {
            return items.sort((a, b) => {
                const aDate = parseDateString(getValue(a));
                const bDate = parseDateString(getValue(b));
                return order === 'asc' ? aDate.getTime() - bDate.getTime() : bDate.getTime() - aDate.getTime();
            });
        };
        const isDate = (value) => {
            const ddMMYYYYhhmmss = /^\d{1,2}\/\d{1,2}\/\d{4}( \d{1,2}:\d{1,2}(:\d{1,2})?)?$/;
            return ddMMYYYYhhmmss.test(value);
        };
        const parseDateString = (value) => {
            const [datePart, timePart] = value.split(' ');
            const separator = value.includes('/') ? '/' : '-';
            const [day, month, year] = datePart.split(separator).map(Number);
            let hours = 0, minutes = 0, seconds = 0;
            if (timePart) {
                const [hourStr, minuteStr, secondStr] = timePart.split(':').map(Number);
                hours = isNaN(hourStr) ? 0 : hourStr;
                minutes = isNaN(minuteStr) ? 0 : minuteStr;
                seconds = isNaN(secondStr) ? 0 : secondStr;
            }
            return new Date(year, month - 1, day, hours, minutes, seconds);
        };
        const getValue = (item) => {
            let value = item;
            const nestedProperty = property.split('.');
            for (let i = 0; i < nestedProperty.length; i++) {
                const property = nestedProperty[i];
                if (!property || typeof value[property] === 'undefined' || value[property] === null) {
                    value = null;
                    break;
                }
                value = value[property];
            }
            return value;
        };
        let output = [...items];
        if (property === '') {
            if (typeof output[0] === 'number' && !isNaN(output[0])) {
                return sortByNumber(output, order);
            }
            else if (isDate(output[0])) {
                return sortByDate(output, order);
            }
            else {
                return sortByString(output, order);
            }
        }
        const index = output.findIndex(_item => {
            const value = getValue(_item);
            return typeof value !== 'undefined' && value !== null;
        });
        if (index === -1) {
            return output;
        }
        const value = getValue(output[index]);
        if (typeof value === 'number' && !isNaN(value)) {
            return sortByNumber(output, order);
        }
        else if (isDate(value)) {
            return sortByDate(output, order);
        }
        else {
            return sortByString(output, order);
        }
    }
    #removeAccentsAndDiacritics(search) {
        if (!search) {
            return '';
        }
        return search.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: BizyOrderByPipe, deps: [], target: i0.ɵɵFactoryTarget.Pipe });
    static ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "14.0.0", version: "16.2.12", ngImport: i0, type: BizyOrderByPipe, name: "bizyOrderBy" });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: BizyOrderByPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'bizyOrderBy'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXJCeS5waXBlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcGlwZXMvc3JjL2xpYi9vcmRlckJ5LnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBaUIsTUFBTSxlQUFlLENBQUM7O0FBS3BELE1BQU0sT0FBTyxlQUFlO0lBQzFCLFNBQVMsQ0FBSSxLQUFlLEVBQUUsUUFBK0IsSUFBSSxFQUFFLFdBQW1CLEVBQUU7UUFDdEYsV0FBVztRQUNYLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDcEIsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELDJCQUEyQjtRQUMzQixJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1lBQ3JCLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxNQUFNLFlBQVksR0FBRyxDQUFDLEtBQWUsRUFBRSxLQUFxQixFQUFZLEVBQUU7WUFDeEUsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBTSxFQUFFLENBQU0sRUFBRSxFQUFFO2dCQUNuQyxJQUFJLE1BQU0sR0FBUSxDQUFDLENBQUM7Z0JBQ3BCLElBQUksTUFBTSxHQUFRLENBQUMsQ0FBQztnQkFDcEIsSUFBSSxRQUFRLEVBQUU7b0JBQ1osTUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDM0MsY0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRTt3QkFDakMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQzt3QkFDM0IsTUFBTSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDN0IsQ0FBQyxDQUFDLENBQUM7aUJBQ0o7Z0JBRUQsSUFBSSxDQUFDLE9BQU8sTUFBTSxLQUFLLFdBQVcsSUFBSSxNQUFNLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFP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d0dBOUlVLGVBQWU7c0dBQWYsZUFBZTs7NEZBQWYsZUFBZTtrQkFIM0IsSUFBSTttQkFBQztvQkFDSixJQUFJLEVBQUUsYUFBYTtpQkFDcEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQaXBlLCBQaXBlVHJhbnNmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbkBQaXBlKHtcbiAgbmFtZTogJ2JpenlPcmRlckJ5J1xufSlcbmV4cG9ydCBjbGFzcyBCaXp5T3JkZXJCeVBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcbiAgdHJhbnNmb3JtPFQ+KGl0ZW1zOiBBcnJheTxUPiwgb3JkZXI6ICdhc2MnIHwgJ2Rlc2MnIHwgbnVsbCA9IG51bGwsIHByb3BlcnR5OiBzdHJpbmcgPSAnJyk6IEFycmF5PFQ+IHtcbiAgICAvLyBObyBpdGVtc1xuICAgIGlmICghaXRlbXMgfHwgIW9yZGVyKSB7XG4gICAgICByZXR1cm4gaXRlbXM7XG4gICAgfVxuXG4gICAgLy8gQXJyYXkgd2l0aCBvbmx5IG9uZSBpdGVtXG4gICAgaWYgKGl0ZW1zLmxlbmd0aCA8PSAxKSB7XG4gICAgICByZXR1cm4gaXRlbXM7XG4gICAgfVxuXG4gICAgY29uc3Qgc29ydEJ5U3RyaW5nID0gKGl0ZW1zOiBBcnJheTxUPiwgb3JkZXI6ICdhc2MnIHwgJ2Rlc2MnKTogQXJyYXk8VD4gPT4ge1xuICAgICAgcmV0dXJuIGl0ZW1zLnNvcnQoKGE6IGFueSwgYjogYW55KSA9PiB7XG4gICAgICAgIGxldCBhVmFsdWU6IGFueSA9IGE7XG4gICAgICAgIGxldCBiVmFsdWU6IGFueSA9IGI7XG4gICAgICAgIGlmIChwcm9wZXJ0eSkge1xuICAgICAgICAgIGNvbnN0IG5lc3RlZFByb3BlcnR5ID0gcHJvcGVydHkuc3BsaXQoJy4nKTtcbiAgICAgICAgICBuZXN0ZWRQcm9wZXJ0eS5mb3JFYWNoKF9wcm9wZXJ0eSA9PiB7XG4gICAgICAgICAgICBhVmFsdWUgPSBhVmFsdWVbX3Byb3BlcnR5XTtcbiAgICAgICAgICAgIGJWYWx1ZSA9IGJWYWx1ZVtfcHJvcGVydHldO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gIFxuICAgICAgICBpZiAoKHR5cGVvZiBhVmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IGFWYWx1ZSA9PT0gbnVsbCkgJiYgKHR5cGVvZiBiVmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IGJWYWx1ZSA9PT0gbnVsbCkpIHtcbiAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICBcbiAgICAgICAgaWYgKCh0eXBlb2YgYVZhbHVlID09PSAndW5kZWZpbmVkJyB8fCBhVmFsdWUgPT09IG51bGwpICYmICh0eXBlb2YgYlZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiBiVmFsdWUgIT09IG51bGwpKSB7XG4gICAgICAgICAgcmV0dXJuIG9yZGVyID09PSAnZGVzYycgPyAxIDogLTE7XG4gICAgICAgIH1cbiAgXG4gICAgICAgIGlmICgodHlwZW9mIGFWYWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgYVZhbHVlICE9PSBudWxsKSAmJiAodHlwZW9mIGJWYWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgYlZhbHVlID09PSBudWxsKSApIHtcbiAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICdkZXNjJyA/IC0xIDogMTtcbiAgICAgICAgfVxuICBcbiAgICAgICAgaWYgKGFWYWx1ZSA9PT0gYlZhbHVlKSB7XG4gICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgXG4gICAgICAgIGlmIChvcmRlciA9PT0gJ2Rlc2MnKSB7XG4gICAgICAgICAgcmV0dXJuICh0aGlzLiNyZW1vdmVBY2NlbnRzQW5kRGlhY3JpdGljcyhTdHJpbmcoYVZhbHVlKSkudG9Mb3dlckNhc2UoKSA+IHRoaXMuI3JlbW92ZUFjY2VudHNBbmREaWFjcml0aWNzKFN0cmluZyhiVmFsdWUpKS50b0xvd2VyQ2FzZSgpID8gLTEgOiAxKTtcbiAgICAgICAgfVxuICBcbiAgICAgICAgcmV0dXJuICh0aGlzLiNyZW1vdmVBY2NlbnRzQW5kRGlhY3JpdGljcyhTdHJpbmcoYlZhbHVlKSkudG9Mb3dlckNhc2UoKSA+IHRoaXMuI3JlbW92ZUFjY2VudHNBbmREaWFjcml0aWNzKFN0cmluZyhhVmFsdWUpKS50b0xvd2VyQ2FzZSgpID8gLTEgOiAxKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHNvcnRCeU51bWJlciA9IChpdGVtczogQXJyYXk8VD4sIG9yZGVyOiAnYXNjJyB8ICdkZXNjJyk6IEFycmF5PFQ+ID0+IHtcbiAgICAgIGlmIChvcmRlciA9PT0gJ2FzYycpIHtcbiAgICAgICAgcmV0dXJuIGl0ZW1zLnNvcnQoKGEsIGIpID0+IE51bWJlcihnZXRWYWx1ZShhKSkgLSBOdW1iZXIoZ2V0VmFsdWUoYikpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBpdGVtcy5zb3J0KChhLCBiKSA9PiBOdW1iZXIoZ2V0VmFsdWUoYikpIC0gTnVtYmVyKGdldFZhbHVlKGEpKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgc29ydEJ5RGF0ZSA9IChpdGVtczogQXJyYXk8VD4sIG9yZGVyOiAnYXNjJyB8ICdkZXNjJyk6IEFycmF5PFQ+ID0+IHtcbiAgICAgIHJldHVybiBpdGVtcy5zb3J0KChhLCBiKSA9PiAge1xuICAgICAgICBjb25zdCBhRGF0ZSA9IHBhcnNlRGF0ZVN0cmluZyhnZXRWYWx1ZShhKSBhcyBzdHJpbmcpXG4gICAgICAgIGNvbnN0IGJEYXRlID0gcGFyc2VEYXRlU3RyaW5nKGdldFZhbHVlKGIpIGFzIHN0cmluZylcbiAgICAgICAgcmV0dXJuIG9yZGVyID09PSAnYXNjJyA/IGFEYXRlLmdldFRpbWUoKSAtICBiRGF0ZS5nZXRUaW1lKCkgOiBiRGF0ZS5nZXRUaW1lKCkgLSAgYURhdGUuZ2V0VGltZSgpXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBpc0RhdGUgPSAodmFsdWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgZGRNTVlZWVloaG1tc3MgPSAgL15cXGR7MSwyfVxcL1xcZHsxLDJ9XFwvXFxkezR9KCBcXGR7MSwyfTpcXGR7MSwyfSg6XFxkezEsMn0pPyk/JC87XG4gICAgICByZXR1cm4gZGRNTVlZWVloaG1tc3MudGVzdCh2YWx1ZSk7XG4gICAgfVxuICBcbiAgICBjb25zdCBwYXJzZURhdGVTdHJpbmcgPSAodmFsdWU6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgW2RhdGVQYXJ0LCB0aW1lUGFydF0gPSB2YWx1ZS5zcGxpdCgnICcpO1xuICAgICAgY29uc3Qgc2VwYXJhdG9yID0gdmFsdWUuaW5jbHVkZXMoJy8nKSA/ICcvJyA6ICctJztcbiAgXG4gICAgICBjb25zdCBbZGF5LCBtb250aCwgeWVhcl0gPSBkYXRlUGFydC5zcGxpdChzZXBhcmF0b3IpLm1hcChOdW1iZXIpO1xuICBcbiAgICAgIGxldCBob3VycyA9IDAsIG1pbnV0ZXMgPSAwLCBzZWNvbmRzID0gMDtcbiAgXG4gICAgICBpZiAodGltZVBhcnQpIHtcbiAgICAgICAgICBjb25zdCBbaG91clN0ciwgbWludXRlU3RyLCBzZWNvbmRTdHJdID0gdGltZVBhcnQuc3BsaXQoJzonKS5tYXAoTnVtYmVyKTtcbiAgICAgICAgICBob3VycyA9IGlzTmFOKGhvdXJTdHIpID8gMCA6IGhvdXJTdHI7XG4gICAgICAgICAgbWludXRlcyA9IGlzTmFOKG1pbnV0ZVN0cikgPyAwIDogbWludXRlU3RyO1xuICAgICAgICAgIHNlY29uZHMgPSBpc05hTihzZWNvbmRTdHIpID8gMCA6IHNlY29uZFN0cjtcbiAgICAgIH1cbiAgXG4gICAgICByZXR1cm4gbmV3IERhdGUoeWVhciwgbW9udGggLSAxLCBkYXksIGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzKTtcbiAgICB9XG5cbiAgICBjb25zdCBnZXRWYWx1ZSA9IChpdGVtOiBUKSA9PiB7XG4gICAgICBsZXQgdmFsdWUgPSBpdGVtO1xuICAgICAgY29uc3QgbmVzdGVkUHJvcGVydHkgPSBwcm9wZXJ0eS5zcGxpdCgnLicpO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5lc3RlZFByb3BlcnR5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHByb3BlcnR5ID0gbmVzdGVkUHJvcGVydHlbaV07XG4gICAgICAgIGlmICghcHJvcGVydHkgfHwgdHlwZW9mIHZhbHVlW3Byb3BlcnR5XSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWVbcHJvcGVydHldID09PSBudWxsKSB7XG4gICAgICAgICAgdmFsdWUgPSBudWxsO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFsdWUgPSB2YWx1ZVtwcm9wZXJ0eV07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBsZXQgb3V0cHV0OiBBcnJheTxUPiA9IFsuLi5pdGVtc107XG5cbiAgICBpZiAocHJvcGVydHkgPT09ICcnKSB7XG4gICAgICBpZiAodHlwZW9mIG91dHB1dFswXSA9PT0gJ251bWJlcicgJiYgIWlzTmFOKG91dHB1dFswXSkpIHtcbiAgICAgICAgcmV0dXJuIHNvcnRCeU51bWJlcihvdXRwdXQsIG9yZGVyKTtcbiAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKG91dHB1dFswXSBhcyBzdHJpbmcpKSB7XG4gICAgICAgIHJldHVybiBzb3J0QnlEYXRlKG91dHB1dCwgb3JkZXIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHNvcnRCeVN0cmluZyhvdXRwdXQsIG9yZGVyKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBpbmRleCA9IG91dHB1dC5maW5kSW5kZXgoX2l0ZW0gPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBnZXRWYWx1ZShfaXRlbSk7XG4gICAgICByZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbDtcbiAgICB9KTtcblxuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIHJldHVybiBvdXRwdXQ7XG4gICAgfVxuXG5cbiAgICBjb25zdCB2YWx1ZSA9IGdldFZhbHVlKG91dHB1dFtpbmRleF0pO1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInICYmICFpc05hTih2YWx1ZSkpIHtcbiAgICAgIHJldHVybiBzb3J0QnlOdW1iZXIob3V0cHV0LCBvcmRlcik7XG4gICAgfSBlbHNlIGlmIChpc0RhdGUodmFsdWUgYXMgc3RyaW5nKSkge1xuICAgICAgcmV0dXJuIHNvcnRCeURhdGUob3V0cHV0LCBvcmRlcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBzb3J0QnlTdHJpbmcob3V0cHV0LCBvcmRlcik7XG4gICAgfVxuICB9XG5cbiAgI3JlbW92ZUFjY2VudHNBbmREaWFjcml0aWNzKHNlYXJjaDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoIXNlYXJjaCkge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIHJldHVybiBzZWFyY2gubm9ybWFsaXplKCdORkQnKSEucmVwbGFjZSgvW1xcdTAzMDAtXFx1MDM2Zl0vZywgJycpO1xuICB9XG59XG4iXX0=